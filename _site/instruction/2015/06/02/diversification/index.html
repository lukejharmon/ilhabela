<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Diversification models &#8211; Comparative methods in R - Ilhabela</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Understand birth-death and trait-dependent bd models.">
    <meta name="author" content="Luke Harmon">
    <meta name="keywords" content="instruction">
    <link rel="canonical" href="http://lukejharmon.github.io/ilhabela/ilhabela/instruction/2015/06/02/diversification/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/ilhabela/css/pixyll.css" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    


    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Diversification models">
    <meta property="og:description" content="Materials for R course.">
    <meta property="og:url" content="http://lukejharmon.github.io/ilhabela/instruction/2015/06/02/diversification/">
    <meta property="og:site_name" content="Comparative methods in R - Ilhabela">

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        
    
</head>

<body class="">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://lukejharmon.github.io/ilhabela" class="site-title">Comparative methods in R - Ilhabela</a>
      <nav class="site-nav right">
        <a href="/ilhabela/about/">About</a>
<a href="/ilhabela/contact/">Contact</a>

      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/lukejharmon"></a>
    
    
    <a class="fa fa-rss" href="/ilhabela/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/lukejharmon"></a>
    
    
    
      <a class="fa fa-envelope" href="mailto:lukeh@uidaho.edu"></a>
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Diversification models</h1>
  <span class="post-meta">Jun 2, 2015</span><br>
  
  <span class="post-meta small">15 minute read</span>
</div>

<article class="post-content">
  <p>We will now study diversification models, including birth-death models and models where diversification rates depend on characters.</p>

<p>We can start by considering a very simple model, the pure-birth model. Under a pure-birth model, lineages accumulate by speciation (there is no extinction) at a constant per-lineage rate lambda.</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>ape<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>TreeSim<span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## Loading required package: geiger
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>diversitree<span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## Loading required package: deSolve
## Loading required package: subplex
## Loading required package: Rcpp
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>laser<span class="p">)</span>

<span class="c1"># We can use TreeSim to simulate a tree under a pure birth model we will use</span>
<span class="c1"># TreeSim and, for now, simulate trees of a fixed age (but varying numbers</span>
<span class="c1"># of taxa)</span>

simTree1 <span class="o">&lt;-</span> sim.bd.age<span class="p">(</span>age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">0</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span>
plot<span class="p">(</span>simTree1<span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-11.png" alt="plot of chunk unnamed-chunk-1"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># notice that if we repeat this command we get a different tree</span>

simTree2 <span class="o">&lt;-</span> sim.bd.age<span class="p">(</span>age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">0</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span>
plot<span class="p">(</span>simTree2<span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-12.png" alt="plot of chunk unnamed-chunk-1"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># the pattern of lineage accumulation through time for a tree can be</span>
<span class="c1"># visualized with a Lineage-through-time plot</span>

ltt.plot<span class="p">(</span>simTree1<span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-13.png" alt="plot of chunk unnamed-chunk-1"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># ok - but we should always log the y-axis for ltt plots</span>
ltt.plot<span class="p">(</span>simTree1<span class="p">,</span> log <span class="o">=</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-14.png" alt="plot of chunk unnamed-chunk-1"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r">ltt.plot<span class="p">(</span>simTree2<span class="p">,</span> log <span class="o">=</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-15.png" alt="plot of chunk unnamed-chunk-1"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># What is the distribution of tree size under a pure-birth model?</span>
ntips <span class="o">&lt;-</span> <span class="kt">numeric</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span><span class="m">1000</span><span class="p">)</span> <span class="p">{</span>
    st <span class="o">&lt;-</span> sim.bd.age<span class="p">(</span>age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">0</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span>
    <span class="c1"># rarely, there will be only one tip, and the function will return &#39;1&#39;</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span>st<span class="p">)</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span>
        ntips<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="kr">else</span> ntips<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="kp">length</span><span class="p">(</span>st<span class="o">$</span>tip.label<span class="p">)</span>
<span class="p">}</span>

hist<span class="p">(</span>ntips<span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-16.png" alt="plot of chunk unnamed-chunk-1"></p>

<p>It is worth showing the shape of LTT plots under a pure-birth model. To simplify this, we can fix both the age of the clade and the number of taxa. To make this work with TreeSim, we should choose a value of lambda that satisfies the expected relationship under a pure-birth model, E[n(t)] = 2 exp(lambda * t). So if we choose t = 10 and lambda = 0.4, as above, then E[N(t)] = 2 exp(0.4 * 10) = about 109 tips.</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">allTheTrees <span class="o">&lt;-</span> sim.bd.taxa.age<span class="p">(</span>n <span class="o">=</span> <span class="m">109</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1000</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">0</span><span class="p">,</span>
    age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> mrca <span class="o">=</span> <span class="bp">T</span><span class="p">)</span>

ltt.plot<span class="p">(</span>allTheTrees<span class="p">[[</span><span class="m">1</span><span class="p">]],</span> log <span class="o">=</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>
<span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="m">2</span><span class="o">:</span><span class="m">1000</span><span class="p">)</span> <span class="p">{</span>
    ltt.lines<span class="p">(</span>allTheTrees<span class="p">[[</span>i<span class="p">]])</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-2.png" alt="plot of chunk unnamed-chunk-2"></p>

<p>So, under a pure-birth model, we expect the lineage-through-time plot to be linear on a log scale. What if we add extinction?</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">allTheTrees2 <span class="o">&lt;-</span> sim.bd.taxa.age<span class="p">(</span>n <span class="o">=</span> <span class="m">109</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1000</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">2</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">1.6</span><span class="p">,</span>
    age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> mrca <span class="o">=</span> <span class="bp">T</span><span class="p">)</span>

ltt.plot<span class="p">(</span>allTheTrees2<span class="p">[[</span><span class="m">1</span><span class="p">]],</span> log <span class="o">=</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>
<span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="m">2</span><span class="o">:</span><span class="m">1000</span><span class="p">)</span> <span class="p">{</span>
    ltt.lines<span class="p">(</span>allTheTrees2<span class="p">[[</span>i<span class="p">]])</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-3.png" alt="plot of chunk unnamed-chunk-3"></p>

<p>Extinction leaves a signature in the shape of phylogenetic trees. We can see that in the lineage-through-time plot, which bends up towards the present day. We can also see this in the trees themselves:</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">simTree1 <span class="o">&lt;-</span> sim.bd.taxa.age<span class="p">(</span>n <span class="o">=</span> <span class="m">109</span><span class="p">,</span> age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">0</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span>
simTree2 <span class="o">&lt;-</span> sim.bd.taxa.age<span class="p">(</span>n <span class="o">=</span> <span class="m">109</span><span class="p">,</span> age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">2</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">1.6</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span>

par<span class="p">(</span>mfcol <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">))</span>
plot<span class="p">(</span>simTree1<span class="p">,</span> main <span class="o">=</span> <span class="s">&quot;Pure Birth&quot;</span><span class="p">)</span>
plot<span class="p">(</span>simTree2<span class="p">,</span> main <span class="o">=</span> <span class="s">&quot;Birth-death&quot;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-4.png" alt="plot of chunk unnamed-chunk-4"></p>

<p>One important thing to keep in mind with diversification rate analysis is that sampling can be critical. To see why, let&rsquo;s use simulations of partially sampled data:</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">simTree1 <span class="o">&lt;-</span> sim.bd.taxa.age<span class="p">(</span>n <span class="o">=</span> <span class="m">109</span><span class="p">,</span> age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">0</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span>
simTree2 <span class="o">&lt;-</span> sim.bd.taxa.age<span class="p">(</span>n <span class="o">=</span> <span class="m">50</span><span class="p">,</span> age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">0</span><span class="p">,</span>
    frac <span class="o">=</span> <span class="m">50</span><span class="o">/</span><span class="m">109</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span>

par<span class="p">(</span>mfcol <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">))</span>
plot<span class="p">(</span>simTree1<span class="p">,</span> main <span class="o">=</span> <span class="s">&quot;Fully sampled&quot;</span><span class="p">)</span>
plot<span class="p">(</span>simTree2<span class="p">,</span> main <span class="o">=</span> <span class="s">&quot;Partially sampled&quot;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-5.png" alt="plot of chunk unnamed-chunk-5"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># what is the general pattern?</span>

allTheTrees3 <span class="o">&lt;-</span> sim.bd.taxa.age<span class="p">(</span>n <span class="o">=</span> <span class="m">50</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1000</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">0</span><span class="p">,</span>
    age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> mrca <span class="o">=</span> <span class="bp">T</span><span class="p">,</span> frac <span class="o">=</span> <span class="m">50</span><span class="o">/</span><span class="m">109</span><span class="p">)</span>
plot.new<span class="p">()</span>
ltt.plot<span class="p">(</span>allTheTrees3<span class="p">[[</span><span class="m">1</span><span class="p">]],</span> log <span class="o">=</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>
<span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="m">2</span><span class="o">:</span><span class="m">1000</span><span class="p">)</span> <span class="p">{</span>
    ltt.lines<span class="p">(</span>allTheTrees3<span class="p">[[</span>i<span class="p">]])</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-6.png" alt="plot of chunk unnamed-chunk-6"></p>

<h1> Estimating speciation and extinction rates </h1>

<p>We can estimate speciation and extinction rates from phylogenetic trees by fitting the models described above, pure-birth and birth-death. We will use diversitree so that we can start to figure out how it works.</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">simTree1 <span class="o">&lt;-</span> sim.bd.age<span class="p">(</span>age <span class="o">=</span> <span class="m">10</span><span class="p">,</span> numbsim <span class="o">=</span> <span class="m">1</span><span class="p">,</span> lambda <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span> mu <span class="o">=</span> <span class="m">0</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span>

<span class="c1"># first fit a Yule model</span>
pbModel <span class="o">&lt;-</span> make.yule<span class="p">(</span>simTree1<span class="p">)</span>
pbMLFit <span class="o">&lt;-</span> find.mle<span class="p">(</span>pbModel<span class="p">,</span> <span class="m">0.1</span><span class="p">)</span>

<span class="c1"># next fit a Birth-death model</span>
bdModel <span class="o">&lt;-</span> make.bd<span class="p">(</span>simTree1<span class="p">)</span>
bdMLFit <span class="o">&lt;-</span> find.mle<span class="p">(</span>bdModel<span class="p">,</span> <span class="kt">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span> <span class="m">0.05</span><span class="p">),</span> method <span class="o">=</span> <span class="s">&quot;optim&quot;</span><span class="p">,</span> lower <span class="o">=</span> <span class="m">0</span><span class="p">)</span>

<span class="c1"># compare models</span>
anova<span class="p">(</span>bdMLFit<span class="p">,</span> pure.birth <span class="o">=</span> pbMLFit<span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">##            Df lnLik   AIC ChiSq Pr(&gt;|Chi|)
## full        2  39.4 -74.7
## pure.birth  1  38.7 -75.3  1.43       0.23
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r">
</code></pre></div>
<p>The beauty of diversitree is that we can very easily run a Bayesian analysis of diversification rates.</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">bdSamples <span class="o">&lt;-</span> mcmc<span class="p">(</span>bdModel<span class="p">,</span> bdMLFit<span class="o">$</span>par<span class="p">,</span> nsteps <span class="o">=</span> <span class="m">1e+05</span><span class="p">,</span> lower <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> upper <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="kc">Inf</span><span class="p">,</span>
    <span class="kc">Inf</span><span class="p">),</span> w <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span> <span class="m">0.1</span><span class="p">),</span> fail.value <span class="o">=</span> <span class="o">-</span><span class="kc">Inf</span><span class="p">,</span> print.every <span class="o">=</span> <span class="m">10000</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## 10000: {0.7066, 0.4345} -&gt; 38.23901
## 20000: {0.6983, 0.4807} -&gt; 38.61153
## 30000: {0.4707, 0.1993} -&gt; 39.34786
## 40000: {0.3968, 0.0109} -&gt; 38.59093
## 50000: {0.5818, 0.5375} -&gt; 37.45965
## 60000: {0.7548, 0.3742} -&gt; 36.23272
## 70000: {0.5073, 0.2229} -&gt; 39.27743
## 80000: {0.7477, 0.5798} -&gt; 38.32425
## 90000: {0.4992, 0.2517} -&gt; 39.36961
## 100000: {0.4649, 0.2432} -&gt; 39.27638
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r">postSamples <span class="o">&lt;-</span> bdSamples<span class="p">[</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;lambda&quot;</span><span class="p">,</span> <span class="s">&quot;mu&quot;</span><span class="p">)]</span>
profiles.plot<span class="p">(</span>postSamples<span class="p">,</span> col.line <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;red&quot;</span><span class="p">,</span> <span class="s">&quot;blue&quot;</span><span class="p">),</span> las <span class="o">=</span> <span class="m">1</span><span class="p">,</span> legend <span class="o">=</span> <span class="s">&quot;topright&quot;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-81.png" alt="plot of chunk unnamed-chunk-8"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># often estimates of r (= lambda-mu) are more precise than either lambda and</span>
<span class="c1"># mu</span>
postSamples<span class="o">$</span>r <span class="o">&lt;-</span> <span class="kp">with</span><span class="p">(</span>bdSamples<span class="p">,</span> lambda <span class="o">-</span> mu<span class="p">)</span>
postSamples<span class="o">$</span>eps <span class="o">&lt;-</span> <span class="kp">with</span><span class="p">(</span>bdSamples<span class="p">,</span> mu<span class="o">/</span>lambda<span class="p">)</span>

profiles.plot<span class="p">(</span>postSamples<span class="p">[,</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;eps&quot;</span><span class="p">)],</span> col.line <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;red&quot;</span><span class="p">,</span> <span class="s">&quot;blue&quot;</span><span class="p">),</span> las <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
    legend <span class="o">=</span> <span class="s">&quot;topright&quot;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-82.png" alt="plot of chunk unnamed-chunk-8"></p>

<h1> Testing for slowdowns </h1>

<p>We can test for slowdowns in the rate of diversification through time using both Pybus and Harvey&rsquo;s gamma - a very common test in the literature - and likelihood using Rabosky&rsquo;s approach.</p>

<p>We can start with gamma:</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># let&#39;s try our simulated tree</span>
gs <span class="o">&lt;-</span> gammaStat<span class="p">(</span>simTree1<span class="p">)</span>
mccrResult <span class="o">&lt;-</span> mccrTest<span class="p">(</span>CladeSize <span class="o">=</span> <span class="kp">length</span><span class="p">(</span>simTree1<span class="o">$</span>tip.label<span class="p">),</span> NumberMissing <span class="o">=</span> <span class="m">0</span><span class="p">,</span>
    NumberOfReps <span class="o">=</span> <span class="m">1000</span><span class="p">,</span> ObservedGamma <span class="o">=</span> gs<span class="p">)</span>

<span class="c1"># now let&#39;s try the anole tree. This tree is incomplete, so we have to</span>
<span class="c1"># account for that.</span>
gsAnole <span class="o">&lt;-</span> gammaStat<span class="p">(</span>anoleTree<span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## Error: object &#39;anoleTree&#39; not found
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r">mccrResultAnole <span class="o">&lt;-</span> mccrTest<span class="p">(</span>CladeSize <span class="o">=</span> <span class="kp">length</span><span class="p">(</span>anoleTree<span class="o">$</span>tip.label<span class="p">),</span> NumberMissing <span class="o">=</span> <span class="m">70</span><span class="p">,</span>
    NumberOfReps <span class="o">=</span> <span class="m">1000</span><span class="p">,</span> ObservedGamma <span class="o">=</span> gsAnole<span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## Error: object &#39;anoleTree&#39; not found
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># we can use likelihood to compare a set of models for diversification. This</span>
<span class="c1"># REQUIRES a complete tree, which we do not have - so these results are</span>
<span class="c1"># incorrect</span>

anoleBTimes <span class="o">&lt;-</span> <span class="kp">sort</span><span class="p">(</span>branching.times<span class="p">(</span>anoleTree<span class="p">),</span> decreasing <span class="o">=</span> <span class="bp">T</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## Error: object &#39;anoleTree&#39; not found
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r">fitdAICrc<span class="p">(</span>anoleBTimes<span class="p">,</span> modelset <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;pureBirth&quot;</span><span class="p">,</span> <span class="s">&quot;bd&quot;</span><span class="p">,</span> <span class="s">&quot;DDX&quot;</span><span class="p">,</span> <span class="s">&quot;DDL&quot;</span><span class="p">,</span> <span class="s">&quot;yule2rate&quot;</span><span class="p">),</span>
    ints <span class="o">=</span> <span class="m">100</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## Error: object &#39;anoleBTimes&#39; not found
</code></pre></div>
<h1> Relating diversification rates to character state </h1>

<p>We can test for a relationship between character state and diversification rates using BiSSE (and related approaches). The syntax for BiSSE is consistent with other aspects of diversitree that we learned above. We will try this with anole ecomorph data. BiSSE can only handle binary traits, so we will have to change our data over to a binary (0-1) character.</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># let&#39;s try a simulated data set to see if we can really detect a true</span>
<span class="c1"># effect</span>

simPars <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="m">0.4</span><span class="p">,</span> <span class="m">0.2</span><span class="p">,</span> <span class="m">0.05</span><span class="p">,</span> <span class="m">0.05</span><span class="p">,</span> <span class="m">0.05</span><span class="p">,</span> <span class="m">0.05</span><span class="p">)</span>
<span class="kp">set.seed</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
simBisseData <span class="o">&lt;-</span> tree.bisse<span class="p">(</span>simPars<span class="p">,</span> max.t <span class="o">=</span> <span class="m">14</span><span class="p">,</span> x0 <span class="o">=</span> <span class="m">0</span><span class="p">)</span>

hist <span class="o">&lt;-</span> history.from.sim.discrete<span class="p">(</span>simBisseData<span class="p">,</span> <span class="m">0</span><span class="o">:</span><span class="m">1</span><span class="p">)</span>
plot<span class="p">(</span>hist<span class="p">,</span> simBisseData<span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-101.png" alt="plot of chunk unnamed-chunk-10"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r">nbModel <span class="o">&lt;-</span> make.bisse<span class="p">(</span>simBisseData<span class="p">,</span> simBisseData<span class="o">$</span>tip.state<span class="p">)</span>
p <span class="o">&lt;-</span> starting.point.bisse<span class="p">(</span>simBisseData<span class="p">)</span>
nbModelMLFit <span class="o">&lt;-</span> find.mle<span class="p">(</span>nbModel<span class="p">,</span> p<span class="p">)</span>

<span class="kp">rbind</span><span class="p">(</span>real <span class="o">=</span> simPars<span class="p">,</span> estimated <span class="o">=</span> <span class="kp">round</span><span class="p">(</span>coef<span class="p">(</span>nbModelMLFit<span class="p">),</span> <span class="m">2</span><span class="p">))</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">##           lambda0 lambda1  mu0  mu1  q01  q10
## real          0.4    0.20 0.05 0.05 0.05 0.05
## estimated     0.4    0.23 0.00 0.47 0.14 0.00
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># we can test a constrained model where the character does not affect</span>
<span class="c1"># diversification rates</span>

cnbModel <span class="o">&lt;-</span> constrain<span class="p">(</span>nbModel<span class="p">,</span> lambda1 <span class="o">~</span> lambda0<span class="p">)</span>
cnbModel <span class="o">&lt;-</span> constrain<span class="p">(</span>cnbModel<span class="p">,</span> mu1 <span class="o">~</span> mu0<span class="p">)</span>

cnbModelMLFit <span class="o">&lt;-</span> find.mle<span class="p">(</span>cnbModel<span class="p">,</span> p<span class="p">[</span><span class="kt">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span> <span class="m">-3</span><span class="p">)])</span>

<span class="c1"># compare models</span>

anova<span class="p">(</span>nbModelMLFit<span class="p">,</span> constrained <span class="o">=</span> cnbModelMLFit<span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">##             Df lnLik AIC ChiSq Pr(&gt;|Chi|)
## full         6  -212 437
## constrained  4  -214 436  2.63       0.27
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># let&#39;s try a Bayesian analysis</span>

prior <span class="o">&lt;-</span> make.prior.exponential<span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="p">(</span><span class="m">2</span> <span class="o">*</span> <span class="m">0.4</span><span class="p">))</span>

<span class="c1"># this is not long enough but ok for now. You might want more like 1000000</span>
<span class="c1"># generations.</span>
mcmcRun <span class="o">&lt;-</span> mcmc<span class="p">(</span>nbModel<span class="p">,</span> nbModelMLFit<span class="o">$</span>par<span class="p">,</span> nsteps <span class="o">=</span> <span class="m">1000</span><span class="p">,</span> prior <span class="o">=</span> prior<span class="p">,</span> w <span class="o">=</span> <span class="m">0.1</span><span class="p">,</span>
    print.every <span class="o">=</span> <span class="m">100</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## 100: {0.4764, 0.2365, 0.1580, 0.4976, 0.1726, 0.0994} -&gt; -214.90686
## 200: {0.5063, 0.2716, 0.0322, 0.2143, 0.1433, 0.2130} -&gt; -215.33748
## 300: {0.5721, 0.5181, 0.4216, 0.1710, 0.1484, 0.6746} -&gt; -219.73947
## 400: {0.4758, 0.1728, 0.0528, 0.0562, 0.1831, 0.4297} -&gt; -214.32404
## 500: {0.4167, 0.4111, 0.0252, 0.5534, 0.2293, 0.4296} -&gt; -215.97337
## 600: {0.2608, 0.3070, 0.0342, 0.2933, 0.2619, 0.3821} -&gt; -222.18071
## 700: {0.4375, 0.7609, 0.1531, 0.5333, 0.8031, 2.9827} -&gt; -225.98707
## 800: {0.4527, 0.1641, 0.3006, 0.3028, 0.0885, 0.0087} -&gt; -218.23327
## 900: {0.4327, 0.2812, 0.1906, 0.1734, 0.1400, 0.3540} -&gt; -215.15756
## 1000: {0.4310, 0.2367, 0.0852, 0.4269, 0.1284, 0.0251} -&gt; -213.39588
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r">col <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;blue&quot;</span><span class="p">,</span> <span class="s">&quot;red&quot;</span><span class="p">)</span>
profiles.plot<span class="p">(</span>mcmcRun<span class="p">[,</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;lambda0&quot;</span><span class="p">,</span> <span class="s">&quot;lambda1&quot;</span><span class="p">)],</span> col.line <span class="o">=</span> <span class="kp">col</span><span class="p">,</span> las <span class="o">=</span> <span class="m">1</span><span class="p">,</span> legend <span class="o">=</span> <span class="s">&quot;topright&quot;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-102.png" alt="plot of chunk unnamed-chunk-10"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r">profiles.plot<span class="p">(</span>mcmcRun<span class="p">[,</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;mu0&quot;</span><span class="p">,</span> <span class="s">&quot;mu1&quot;</span><span class="p">)],</span> col.line <span class="o">=</span> <span class="kp">col</span><span class="p">,</span> las <span class="o">=</span> <span class="m">1</span><span class="p">,</span> legend <span class="o">=</span> <span class="s">&quot;topright&quot;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/ilhabela/images/bd/unnamed-chunk-103.png" alt="plot of chunk unnamed-chunk-10"></p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># looks like speciation rate differs, but not extinction. can we confirm?</span>
<span class="kp">sum</span><span class="p">(</span>mcmcRun<span class="o">$</span>lambda0 <span class="o">&gt;</span> mcmcRun<span class="o">$</span>lambda1<span class="p">)</span><span class="o">/</span><span class="kp">length</span><span class="p">(</span>mcmcRun<span class="o">$</span>lambda1<span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## [1] 0.875
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kp">sum</span><span class="p">(</span>mcmcRun<span class="o">$</span>mu0 <span class="o">&gt;</span> mcmcRun<span class="o">$</span>mu1<span class="p">)</span><span class="o">/</span><span class="kp">length</span><span class="p">(</span>mcmcRun<span class="o">$</span>mu1<span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">## [1] 0.212
</code></pre></div>
<h1> Challenge problem </h1>

<p>Repeat the above analyses with anoles (using the trait below). Fit a BiSSE model using both ML and Bayesian methods. What do you conclude?</p>

<p>You need a binary trait, so use the following:</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">anoleData <span class="o">&lt;-</span> read.csv<span class="p">(</span><span class="s">&quot;~/Documents/teaching/revellClass/2014bogota/continuousModels/anolisDataAppended.csv&quot;</span><span class="p">,</span>
    row.names <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
anoleTree <span class="o">&lt;-</span> read.tree<span class="p">(</span><span class="s">&quot;~/Documents/teaching/revellClass/2014bogota/continuousModels/anolis.phy&quot;</span><span class="p">)</span>

ecomorph <span class="o">&lt;-</span> anoleData<span class="p">[,</span> <span class="s">&quot;ecomorph&quot;</span><span class="p">]</span>
<span class="kp">names</span><span class="p">(</span>ecomorph<span class="p">)</span> <span class="o">&lt;-</span> <span class="kp">rownames</span><span class="p">(</span>anoleData<span class="p">)</span>

isTG <span class="o">&lt;-</span> <span class="kp">as.numeric</span><span class="p">(</span>ecomorph <span class="o">==</span> <span class="s">&quot;TG&quot;</span><span class="p">)</span>
<span class="kp">names</span><span class="p">(</span>isTG<span class="p">)</span> <span class="o">&lt;-</span> <span class="kp">names</span><span class="p">(</span>ecomorph<span class="p">)</span>
isTG
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">##            ahli         alayoni         alfaroi        aliniger
##               1               0               0               0
##        allisoni         allogus   altitudinalis         alumina
##               0               1               0               0
##       alutaceus     angusticeps     argenteolus     argillaceus
##               0               0               0               0
##         armouri   bahorucoensis        baleatus        baracoae
##               1               0               0               0
##       barahonae        barbatus        barbouri        bartschi
##               0               0               0               0
##         bremeri        breslini    brevirostris        caudalis
##               1               1               0               0
##       centralis  chamaeleonides    chlorocyanus     christophei
##               0               0               0               0
##       clivicola     coelestinus        confusus           cooki
##               0               0               1               1
##    cristatellus    cupeyalensis         cuvieri    cyanopleurus
##               1               0               0               0
##         cybotes     darlingtoni       distichus dolichocephalus
##               1               0               0               0
##       equestris      etheridgei   eugenegrahami       evermanni
##               0               0               0               0
##         fowleri         garmani         grahami           guafe
##               0               0               0               1
##       guamuhaya         guazuma       gundlachi       haetianus
##               0               0               1               1
##      hendersoni      homolechis           imias    inexpectatus
##               0               1               1               0
##       insolitus        isolepis           jubar           krugi
##               0               0               1               0
##      lineatopus   longitibialis        loysiana          lucius
##               1               1               0               0
##    luteogularis      macilentus        marcanoi          marron
##               0               0               1               0
##         mestrei       monticola          noblei        occultus
##               1               0               0               0
##         olssoni        opalinus      ophiolepis        oporinus
##               0               0               0               0
##        paternus        placidus       poncensis        porcatus
##               0               0               0               0
##          porcus      pulchellus         pumilis quadriocellifer
##               0               0               0               1
##      reconditus        ricordii     rubribarbus          sagrei
##               0               0               1               1
##    semilineatus        sheplani         shrevei      singularis
##               0               0               1               0
##      smallwoodi         strahmi       stratulus     valencienni
##               0               1               0               0
##       vanidicus    vermiculatus        websteri       whitemani
##               0               0               0               1
</code></pre></div>
</article>


  <div class="share-page">
  share

  <div class="share-links">
    
      <a class = "fa fa-facebook" href="https://facebook.com/sharer.php?u=http://lukejharmon.github.io/ilhabela/instruction/2015/06/02/diversification/" rel="nofollow" target="_blank" title="Share on Facebook"></a>
    

    
      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=Diversification models&url=http://lukejharmon.github.io/ilhabela/instruction/2015/06/02/diversification/" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    
      <a class="fa fa-google-plus" href="https://plus.google.com/share?url=http://lukejharmon.github.io/ilhabela/instruction/2015/06/02/diversification/" rel="nofollow" target="_blank" title="Share on Google+"></a>
    

    

    

    

    

    

    


  </div>
</div>






  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname  = 'ilhabelamacro';
    var disqus_identifier = '/instruction/2015/06/02/diversification';

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    <div class="measure mt1 center">
      <small>
        Crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).<br>
        &lt;/&gt; available on <a href="https://github.com/johnotander/pixyll">Github</a>.
      </small>
    </div>
  </div>
</footer>

</body>
</html>
